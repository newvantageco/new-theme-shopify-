{% comment %}
  UK Compliance Module
  - GDPR-compliant cookie consent
  - WCAG 2.1 AA accessibility
  - UK-specific legal requirements
  - VAT display compliance
{% endcomment %}

<style>
/* ========================================
   GDPR COOKIE CONSENT - UK COMPLIANT
   ======================================== */
.nvc-cookie-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(10px);
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
  z-index: 10000;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
}

.nvc-cookie-banner.is-visible {
  transform: translateY(0);
}

.nvc-cookie-content {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 2rem;
  align-items: center;
}

@media (max-width: 768px) {
  .nvc-cookie-content {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
}

.nvc-cookie-text {
  font-size: 0.9rem;
  line-height: 1.6;
  color: #333;
}

.nvc-cookie-text a {
  color: #000;
  text-decoration: underline;
  font-weight: 500;
}

.nvc-cookie-actions {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.nvc-cookie-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.nvc-cookie-btn-accept {
  background: #000;
  color: #fff;
}

.nvc-cookie-btn-accept:hover {
  background: #333;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.nvc-cookie-btn-settings {
  background: transparent;
  color: #000;
  border: 2px solid #000;
}

.nvc-cookie-btn-settings:hover {
  background: rgba(0, 0, 0, 0.05);
}

.nvc-cookie-btn-reject {
  background: transparent;
  color: #666;
  border: 1px solid #ccc;
}

.nvc-cookie-btn-reject:hover {
  border-color: #999;
  color: #000;
}

/* Cookie Preferences Modal */
.nvc-cookie-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 10001;
  padding: 2rem;
  overflow-y: auto;
}

.nvc-cookie-modal.is-open {
  display: flex;
  align-items: center;
  justify-content: center;
}

.nvc-cookie-modal-content {
  background: #fff;
  border-radius: 12px;
  max-width: 600px;
  width: 100%;
  padding: 2rem;
  position: relative;
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(40px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.nvc-cookie-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.nvc-cookie-modal-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
}

.nvc-cookie-modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
  color: #666;
}

.nvc-cookie-category {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.02);
  border-radius: 8px;
}

.nvc-cookie-category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.nvc-cookie-category-title {
  font-weight: 600;
  font-size: 1rem;
  margin: 0;
}

.nvc-cookie-category-required {
  font-size: 0.75rem;
  color: #666;
  font-style: italic;
}

.nvc-cookie-toggle {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
}

.nvc-cookie-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.nvc-cookie-toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.3s;
  border-radius: 24px;
}

.nvc-cookie-toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

.nvc-cookie-toggle input:checked + .nvc-cookie-toggle-slider {
  background-color: #000;
}

.nvc-cookie-toggle input:checked + .nvc-cookie-toggle-slider:before {
  transform: translateX(24px);
}

.nvc-cookie-toggle input:disabled + .nvc-cookie-toggle-slider {
  opacity: 0.5;
  cursor: not-allowed;
}

.nvc-cookie-category-desc {
  font-size: 0.85rem;
  line-height: 1.5;
  color: #666;
  margin: 0;
}

.nvc-cookie-modal-actions {
  display: flex;
  gap: 1rem;
  margin-top: 2rem;
}

/* ========================================
   ACCESSIBILITY ENHANCEMENTS
   ======================================== */
.nvc-skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: #000;
  color: #fff;
  padding: 8px 16px;
  text-decoration: none;
  z-index: 10002;
}

.nvc-skip-link:focus {
  top: 0;
}

/* Screen reader only utility */
.nvc-sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

/* Focus visible styles */
.nvc-focus-visible:focus-visible {
  outline: 3px solid #000;
  outline-offset: 3px;
}

/* ========================================
   VAT DISPLAY (UK REQUIREMENT)
   ======================================== */
.nvc-price-vat {
  font-size: 0.85em;
  color: #666;
  margin-top: 0.25rem;
}

/* ========================================
   LEGAL COMPLIANCE BADGES
   ======================================== */
.nvc-compliance-badges {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  padding: 1rem 0;
}

.nvc-compliance-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 6px;
  font-size: 0.85rem;
  color: #333;
}

.nvc-compliance-badge svg {
  width: 20px;
  height: 20px;
}
</style>

{% comment %} Cookie Consent Banner {% endcomment %}
<div class="nvc-cookie-banner" id="nvcCookieBanner" role="dialog" aria-labelledby="cookieBannerTitle" aria-describedby="cookieBannerDesc">
  <div class="nvc-cookie-content">
    <div class="nvc-cookie-text">
      <p id="cookieBannerTitle" style="margin: 0 0 0.5rem 0; font-weight: 600;">We value your privacy</p>
      <p id="cookieBannerDesc" style="margin: 0;">
        We use cookies to enhance your browsing experience, serve personalised content, and analyse our traffic. 
        By clicking "Accept All", you consent to our use of cookies. 
        <a href="/pages/privacy-policy">Privacy Policy</a> | 
        <a href="/pages/cookie-policy">Cookie Policy</a>
      </p>
    </div>
    <div class="nvc-cookie-actions">
      <button class="nvc-cookie-btn nvc-cookie-btn-accept" id="acceptAllCookies" aria-label="Accept all cookies">
        Accept All
      </button>
      <button class="nvc-cookie-btn nvc-cookie-btn-settings" id="cookieSettings" aria-label="Manage cookie preferences">
        Manage Preferences
      </button>
      <button class="nvc-cookie-btn nvc-cookie-btn-reject" id="rejectCookies" aria-label="Reject optional cookies">
        Reject All
      </button>
    </div>
  </div>
</div>

{% comment %} Cookie Preferences Modal {% endcomment %}
<div class="nvc-cookie-modal" id="cookieModal" role="dialog" aria-modal="true" aria-labelledby="cookieModalTitle">
  <div class="nvc-cookie-modal-content">
    <div class="nvc-cookie-modal-header">
      <h2 class="nvc-cookie-modal-title" id="cookieModalTitle">Cookie Preferences</h2>
      <button class="nvc-cookie-modal-close" id="closeCookieModal" aria-label="Close cookie preferences">Ã—</button>
    </div>
    
    <div class="nvc-cookie-categories">
      <div class="nvc-cookie-category">
        <div class="nvc-cookie-category-header">
          <div>
            <h3 class="nvc-cookie-category-title">Essential Cookies</h3>
            <span class="nvc-cookie-category-required">Always Active</span>
          </div>
          <label class="nvc-cookie-toggle">
            <input type="checkbox" checked disabled aria-label="Essential cookies are always active">
            <span class="nvc-cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="nvc-cookie-category-desc">
          These cookies are necessary for the website to function and cannot be switched off. They are usually only set in response to actions made by you such as setting your privacy preferences, logging in or filling in forms.
        </p>
      </div>

      <div class="nvc-cookie-category">
        <div class="nvc-cookie-category-header">
          <div>
            <h3 class="nvc-cookie-category-title">Analytics Cookies</h3>
          </div>
          <label class="nvc-cookie-toggle">
            <input type="checkbox" id="analyticsCookies" aria-label="Toggle analytics cookies">
            <span class="nvc-cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="nvc-cookie-category-desc">
          These cookies allow us to count visits and traffic sources so we can measure and improve the performance of our site. They help us understand which pages are most popular and how visitors move around the site.
        </p>
      </div>

      <div class="nvc-cookie-category">
        <div class="nvc-cookie-category-header">
          <div>
            <h3 class="nvc-cookie-category-title">Marketing Cookies</h3>
          </div>
          <label class="nvc-cookie-toggle">
            <input type="checkbox" id="marketingCookies" aria-label="Toggle marketing cookies">
            <span class="nvc-cookie-toggle-slider"></span>
          </label>
        </div>
        <p class="nvc-cookie-category-desc">
          These cookies may be set through our site by our advertising partners. They may be used to build a profile of your interests and show you relevant adverts on other sites.
        </p>
      </div>
    </div>

    <div class="nvc-cookie-modal-actions">
      <button class="nvc-cookie-btn nvc-cookie-btn-accept" id="savePreferences" style="flex: 1;">
        Save Preferences
      </button>
      <button class="nvc-cookie-btn nvc-cookie-btn-settings" id="acceptAllModal">
        Accept All
      </button>
    </div>
  </div>
</div>

{% comment %} Skip to main content link for accessibility {% endcomment %}
<a href="#MainContent" class="nvc-skip-link">Skip to main content</a>

<script>
(function() {
  'use strict';
  
  const COOKIE_NAME = 'nvc_cookie_consent';
  const COOKIE_EXPIRY_DAYS = 365;
  
  const CookieConsent = {
    init() {
      this.checkConsent();
      this.bindEvents();
    },
    
    checkConsent() {
      const consent = this.getCookie(COOKIE_NAME);
      if (!consent) {
        setTimeout(() => {
          document.getElementById('nvcCookieBanner').classList.add('is-visible');
        }, 1000);
      } else {
        this.applyConsent(JSON.parse(consent));
      }
    },
    
    bindEvents() {
      // Accept all
      document.getElementById('acceptAllCookies')?.addEventListener('click', () => {
        this.setConsent({ essential: true, analytics: true, marketing: true });
        this.hideBanner();
      });
      
      // Reject all
      document.getElementById('rejectCookies')?.addEventListener('click', () => {
        this.setConsent({ essential: true, analytics: false, marketing: false });
        this.hideBanner();
      });
      
      // Open settings
      document.getElementById('cookieSettings')?.addEventListener('click', () => {
        this.openModal();
      });
      
      // Close modal
      document.getElementById('closeCookieModal')?.addEventListener('click', () => {
        this.closeModal();
      });
      
      // Save preferences
      document.getElementById('savePreferences')?.addEventListener('click', () => {
        const analytics = document.getElementById('analyticsCookies').checked;
        const marketing = document.getElementById('marketingCookies').checked;
        this.setConsent({ essential: true, analytics, marketing });
        this.closeModal();
        this.hideBanner();
      });
      
      // Accept all from modal
      document.getElementById('acceptAllModal')?.addEventListener('click', () => {
        document.getElementById('analyticsCookies').checked = true;
        document.getElementById('marketingCookies').checked = true;
        this.setConsent({ essential: true, analytics: true, marketing: true });
        this.closeModal();
        this.hideBanner();
      });
      
      // Close modal on backdrop click
      document.getElementById('cookieModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'cookieModal') {
          this.closeModal();
        }
      });
      
      // Keyboard accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('cookieModal').classList.contains('is-open')) {
          this.closeModal();
        }
      });
    },
    
    setConsent(preferences) {
      this.setCookie(COOKIE_NAME, JSON.stringify(preferences), COOKIE_EXPIRY_DAYS);
      this.applyConsent(preferences);
    },
    
    applyConsent(preferences) {
      // Apply analytics
      if (preferences.analytics) {
        // Load Google Analytics or your analytics script
        // Analytics cookies enabled
      }
      
      // Apply marketing
      if (preferences.marketing) {
        // Load marketing scripts
        // Marketing cookies enabled
      }
      
      // Dispatch custom event for other scripts to listen to
      window.dispatchEvent(new CustomEvent('nvcCookieConsent', { detail: preferences }));
    },
    
    openModal() {
      document.getElementById('cookieModal').classList.add('is-open');
      document.body.style.overflow = 'hidden';
      
      // Trap focus in modal
      const modal = document.getElementById('cookieModal');
      const focusableElements = modal.querySelectorAll('button, input, a, [tabindex]:not([tabindex="-1"])');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      firstElement?.focus();
    },
    
    closeModal() {
      document.getElementById('cookieModal').classList.remove('is-open');
      document.body.style.overflow = '';
    },
    
    hideBanner() {
      document.getElementById('nvcCookieBanner').classList.remove('is-visible');
    },
    
    setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
    },
    
    getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
      }, '');
    }
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => CookieConsent.init());
  } else {
    CookieConsent.init();
  }
  
  // Expose for external use
  window.NVCCookieConsent = CookieConsent;
})();
</script>
